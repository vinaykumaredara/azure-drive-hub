{"version":3,"file":"useBooking-CNs_dJjb.js","sources":["../../node_modules/lucide-react/dist/esm/icons/circle.js","../../node_modules/lucide-react/dist/esm/icons/map-pin.js","../../src/hooks/useBooking.ts"],"sourcesContent":["/**\n * @license lucide-react v0.462.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst Circle = createLucideIcon(\"Circle\", [\n  [\"circle\", { cx: \"12\", cy: \"12\", r: \"10\", key: \"1mglay\" }]\n]);\n\nexport { Circle as default };\n//# sourceMappingURL=circle.js.map\n","/**\n * @license lucide-react v0.462.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst MapPin = createLucideIcon(\"MapPin\", [\n  [\n    \"path\",\n    {\n      d: \"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0\",\n      key: \"1r0f0z\"\n    }\n  ],\n  [\"circle\", { cx: \"12\", cy: \"10\", r: \"3\", key: \"ilqhr7\" }]\n]);\n\nexport { MapPin as default };\n//# sourceMappingURL=map-pin.js.map\n","import { useState, useEffect } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { useAuth } from \"@/components/AuthProvider\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\n\r\ninterface BookingDraft {\r\n  carId: string;\r\n  pickup: {\r\n    date: string;\r\n    time: string;\r\n  };\r\n  return: {\r\n    date: string;\r\n    time: string;\r\n  };\r\n  addons: Record<string, boolean>;\r\n  totals: {\r\n    subtotal: number;\r\n    serviceCharge: number;\r\n    total: number;\r\n  };\r\n}\r\n\r\ninterface SaveDraftOptions {\r\n  redirectToProfile?: boolean;\r\n}\r\n\r\nexport const useBooking = () => {\r\n  const { user } = useAuth();\r\n  const navigate = useNavigate();\r\n  const [pendingBooking, setPendingBooking] = useState<BookingDraft | null>(null);\r\n\r\n  // Check for pending booking on component mount\r\n  useEffect(() => {\r\n    const draftRaw = sessionStorage.getItem('pendingBooking');\r\n    if (draftRaw) {\r\n      try {\r\n        const draft = JSON.parse(draftRaw);\r\n        setPendingBooking(draft);\r\n      } catch (error) {\r\n        console.error(\"Failed to parse pending booking:\", error);\r\n        sessionStorage.removeItem('pendingBooking');\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  const saveDraftAndRedirect = (draft: BookingDraft, options: SaveDraftOptions = {}) => {\r\n    // Save booking draft to session storage\r\n    sessionStorage.setItem('pendingBooking', JSON.stringify(draft));\r\n    \r\n    // Add debug logging\r\n    console.log('saveDraftAndRedirect called:', { draft, options });\r\n    \r\n    // Set flags in sessionStorage for post-login handling\r\n    if (options.redirectToProfile) {\r\n      sessionStorage.setItem('redirectToProfileAfterLogin', 'true');\r\n    }\r\n    \r\n    // Redirect to login with return URL (single-level param only)\r\n    navigate(`/auth?next=${encodeURIComponent(window.location.pathname)}`);\r\n  };\r\n\r\n  const clearDraft = () => {\r\n    sessionStorage.removeItem('pendingBooking');\r\n    sessionStorage.removeItem('redirectToProfileAfterLogin');\r\n    setPendingBooking(null);\r\n  };\r\n\r\n  const checkLicenseStatus = async () => {\r\n    if (!user) {return false;}\r\n\r\n    try {\r\n      // Check if user has uploaded a license and if it's verified\r\n      const { data: licenses, error } = await supabase\r\n        .from('licenses')\r\n        .select('id, verified')\r\n        .eq('user_id', user.id)\r\n        .order('created_at', { ascending: false })\r\n        .limit(1);\r\n\r\n      if (error) {throw error;}\r\n\r\n      // Return true if user has at least one verified license\r\n      return licenses && licenses.length > 0 && (licenses[0] as any).verified;\r\n    } catch (error) {\r\n      console.error(\"License check error:\", error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Failed to check license status\",\r\n        variant: \"destructive\",\r\n      });\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const createBookingHold = async (draft: BookingDraft, payMode: \"full\" | \"hold\") => {\r\n    if (!user) {\r\n      saveDraftAndRedirect(draft);\r\n      return null;\r\n    }\r\n\r\n    // Add defensive validation client-side before calling server\r\n    if (!draft.carId || !draft.pickup?.date || !draft.pickup?.time || !draft.return?.date || !draft.return?.time) {\r\n      const error = new Error(\"Missing required booking information. Please fill in all date and time fields.\");\r\n      console.error(\"Create booking hold validation error:\", error);\r\n      toast({\r\n        title: \"Validation Error\",\r\n        description: error.message,\r\n        variant: \"destructive\",\r\n      });\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      // Call Edge Function to create booking hold\r\n      const { data, error } = await supabase.functions.invoke('create-hold', {\r\n        body: {\r\n          carId: draft.carId,\r\n          pickup: draft.pickup,\r\n          return: draft.return,\r\n          addons: draft.addons,\r\n          totals: draft.totals,\r\n          payMode\r\n        }\r\n      });\r\n\r\n      if (error) {throw error;}\r\n\r\n      if (!data.success) {\r\n        throw new Error(data.error || \"Failed to create booking hold\");\r\n      }\r\n\r\n      toast({\r\n        title: \"Booking Hold Created\",\r\n        description: payMode === \"hold\" \r\n          ? \"Your booking is reserved for 24 hours. Complete payment within this time.\" \r\n          : \"Booking created successfully.\",\r\n      });\r\n\r\n      return data;\r\n    } catch (error: any) {\r\n      console.error(\"Create booking hold error:\", error);\r\n      const errorMessage = error?.message || \"Failed to create booking. Please try again.\";\r\n      toast({\r\n        title: \"Booking Failed\",\r\n        description: errorMessage,\r\n        variant: \"destructive\",\r\n      });\r\n      return null;\r\n    }\r\n  };\r\n\r\n  return {\r\n    pendingBooking,\r\n    saveDraftAndRedirect,\r\n    clearDraft,\r\n    checkLicenseStatus,\r\n    createBookingHold\r\n  };\r\n};"],"names":["Circle","createLucideIcon","MapPin","useBooking","user","useAuth","navigate","useNavigate","pendingBooking","setPendingBooking","useState","useEffect","draftRaw","draft","error","saveDraftAndRedirect","options","licenses","supabase","toast","payMode","data","errorMessage"],"mappings":"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","x_google_ignoreList":[0,1]}