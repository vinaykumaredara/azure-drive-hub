import{r,j as e,s as d,B as m,X as $,t as z,v as B,E as G,G as C,w as g}from"./index-CvoPUybl.js";import{b as O,I as V}from"./input-DMosRNSl.js";import{L as w}from"./label-D0-GUShF.js";import{B as H}from"./badge-GQmDJRT9.js";import{S as Y}from"./separator-CVbJ09D4.js";import{C as q}from"./check-C6nFDVMd.js";import{G as Q}from"./gift--hgZj8e5.js";import{A as X}from"./index-OBmW1Lsg.js";import{P as J}from"./percent-DLAlCB2a.js";import{I as K}from"./indian-rupee-CPbtPu67.js";import{T as M}from"./tag-B-t4CA7g.js";import{L as P}from"./loader-circle-DZ0-E_u0.js";const me=({onPromoApplied:A,onPromoRemoved:E,totalAmount:v,className:I=""})=>{const{user:W}=O(),[l,x]=r.useState(!1),[i,f]=r.useState(""),[o,j]=r.useState(null),[h,y]=r.useState(!1),[N,u]=r.useState(null),[p,F]=r.useState([]),[S,_]=r.useState(!1),k=async()=>{try{_(!0);const{data:s,error:t}=await C.from("promo_codes").select("*").eq("active",!0).limit(5).order("created_at",{ascending:!1});if(t)throw t;const a=new Date,c=(s||[]).filter(n=>!(n.valid_to&&new Date(n.valid_to)<a||n.valid_from&&new Date(n.valid_from)>a||n.usage_limit&&n.times_used>=n.usage_limit));F(c)}catch(s){console.error("Error fetching promo codes:",s)}finally{_(!1)}};r.useEffect(()=>{l&&!p.length&&k()},[l,p.length]);const R=async s=>{try{const{data:t,error:a}=await C.rpc("validate_promo_code",{code_input:s.toUpperCase()});if(a)throw console.error("RPC Error:",a),a;if(console.log("RPC Response:",t),t&&Array.isArray(t)&&t.length>0){const c=t[0];return{valid:c.valid,message:c.message,discount_percent:c.discount_percent,discount_flat:c.discount_flat}}return{valid:!1,message:"Invalid promo code"}}catch(t){return console.error("Error validating promo code:",t),{valid:!1,message:"Failed to validate promo code"}}},b=async()=>{if(i.trim()){y(!0),u(null);try{const s=await R(i.trim());if(s.valid){const t=s.discount_percent?v*s.discount_percent/100:s.discount_flat||0,a=s.discount_percent?"percent":"flat";j({code:i.toUpperCase(),discount:t,type:a}),A(t,i.toUpperCase(),a),g({title:"Promo Code Applied!",description:`You saved ₹${t.toFixed(2)} with code ${i.toUpperCase()}`}),f(""),x(!1)}else u(s.message),g({title:"Invalid Promo Code",description:s.message,variant:"destructive"})}catch(s){console.error("Error applying promo code:",s),u("Failed to apply promo code")}finally{y(!1)}}},L=()=>{j(null),E(),g({title:"Promo Code Removed",description:"Promo code discount has been removed"})},T=async s=>{f(s.code),await b()},D=s=>s.discount_percent?`${s.discount_percent}% OFF`:s.discount_flat?`₹${s.discount_flat} OFF`:"DISCOUNT",U=s=>s.discount_percent&&s.discount_percent>=50?"bg-red-100 text-red-700 border-red-200":s.discount_percent&&s.discount_percent>=25?"bg-orange-100 text-orange-700 border-orange-200":s.discount_flat&&s.discount_flat>=500?"bg-red-100 text-red-700 border-red-200":s.discount_flat&&s.discount_flat>=200?"bg-orange-100 text-orange-700 border-orange-200":"bg-green-100 text-green-700 border-green-200";return e.jsxs("div",{className:`space-y-3 ${I}`,children:[o&&e.jsx(d.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5 text-green-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-green-800",children:['Code "',o.code,'" Applied']}),e.jsxs("p",{className:"text-sm text-green-600",children:["You saved ₹",o.discount.toFixed(2),o.type==="percent"&&e.jsxs("span",{className:"ml-1",children:["(",(o.discount/v*100).toFixed(0),"% off)"]})]})]})]}),e.jsx(m,{variant:"ghost",size:"sm",onClick:L,className:"text-green-600 hover:text-green-700 hover:bg-green-100",children:e.jsx($,{className:"w-4 h-4"})})]})}),!o&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>x(!l),className:"text-primary hover:text-primary-foreground hover:bg-primary p-0 h-auto font-normal",children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"Have a promo code?"]}),!l&&e.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},className:"text-xs text-muted-foreground",children:"Click to apply discount"})]}),e.jsx(X,{children:l&&!o&&e.jsx(d.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx(z,{className:"border border-dashed border-primary/30",children:e.jsxs(B,{className:"p-4 space-y-4",children:[p.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(w,{className:"text-sm font-medium text-muted-foreground",children:"Available Promo Codes"}),e.jsx("div",{className:"space-y-2",children:p.slice(0,3).map(s=>e.jsxs(d.div,{whileHover:{scale:1.02},whileTap:{scale:.98},className:`p-3 border rounded-lg cursor-pointer transition-all ${U(s)} hover:shadow-sm`,onClick:()=>T(s),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[s.discount_percent?e.jsx(J,{className:"w-4 h-4"}):e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{className:"font-mono font-bold text-sm",children:s.code})]}),e.jsx(H,{variant:"secondary",className:"text-xs",children:D(s)})]}),e.jsx(m,{size:"sm",variant:"ghost",className:"h-6 px-2 text-xs",children:"Apply"})]}),s.usage_limit&&e.jsxs("p",{className:"text-xs mt-1 opacity-75",children:[s.usage_limit-(s.times_used||0)," uses left"]})]},s.id))}),e.jsx(Y,{})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(w,{htmlFor:"promo-input",className:"text-sm font-medium",children:"Enter Promo Code"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(M,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(V,{id:"promo-input",placeholder:"FIRST50",value:i,onChange:s=>{f(s.target.value.toUpperCase()),u(null)},className:"pl-10 uppercase",disabled:h})]}),e.jsx(m,{onClick:b,disabled:!i.trim()||h,className:"min-w-[80px]",children:h?e.jsx(P,{className:"w-4 h-4 animate-spin"}):"Apply"})]}),N&&e.jsxs(d.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"flex items-center gap-2 text-sm text-red-600",children:[e.jsx(G,{className:"w-4 h-4"}),N]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2",children:[e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>x(!1),className:"text-muted-foreground hover:text-foreground",children:"Cancel"}),S&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(P,{className:"w-3 h-3 animate-spin"}),"Loading offers..."]})]})]})})})})]})};export{me as PromoCodeInput};
//# sourceMappingURL=PromoCodeInput-BiLAi5p7.js.map
